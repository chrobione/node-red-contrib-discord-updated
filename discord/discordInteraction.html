<script type="text/javascript">
  RED.nodes.registerType('discordInteraction', {
    category: 'Discord · Event Intake',
    color: '#7289da',
    defaults: {
      name: {
        value: "",
        required: false
      },
      token: {
        value: "",
        required: true,
        type: "discord-token"
      },
      interactionType: {
        value: "all",
        required: false
      },
      custom_id: {
        value: "",
        required: false
      },
      commandResponse: {
        value: "",
        required: false
      },
      interactionObject: {
        value: false,
        required: false
      },
      ephemeral: {
        value: false,
        required: false
      },
      responseType: {
        value: "update",
        required: false
      },
      commandResponseType: {
        value: "defersReply",
        required: false
      },
    },
    inputs: 0,
    outputs: 1,
    icon: "font-awesome/fa-hand-pointer-o",
    paletteLabel: 'Discord Interaction',
    oneditprepare: () => {
      $("#node-input-interactionType").typedInput({
        types: [
          {
            value: "all",
            options: [
              { value: "all", label: "All" },              
              { value: "button", label: "Button" },
              { value: "command", label: "Command" },
              { value: "selectMenu", label: "String Select Menu" },
              { value: "userSelect", label: "User Select Menu" },
              { value: "roleSelect", label: "Role Select Menu" },
              { value: "mentionableSelect", label: "Mentionable Select Menu" },
              { value: "channelSelect", label: "Channel Select Menu" },
              { value: "autoComplete", label: "Autocomplete" },
              { value: "modalSubmit", label: "Modal Submit" },
              { value: "messageContextMenu", label: "Message Context Menu" }
            ]
          }
        ]
      });
      $("#node-input-responseType").typedInput({
        types: [
          {
            value: "update",
            options: [
              { value: "update", label: "Update Interaction" },              
              { value: "reply", label: "Reply Interaction" }              
            ]
          }
        ]
      });
      $("#node-input-commandResponseType").typedInput({
        types: [
          {
            value: "defersReply",
            options: [
              { value: "defersReply", label: "Defers Reply" },              
              { value: "nothing", label: "Do nothing" }              
            ]
          }
        ]
      });      
      $("#node-input-interactionType").change(function () {
        if ($("#node-input-interactionType").val() == "command" || $("#node-input-interactionType").val() == "messageContextMenu") {
          $("#node-input-custom_id-lbl").text("Command names");          
          $("#node-row-responseType").prop("style", "display:none;");
          if ($("#node-input-interactionType").val() == "command")
          {
            $("#node-row-ephemeral").prop("style", "");
            $("#node-row-commandResponseType").prop("style", "");
          }            
          else
          {
            $("#node-row-ephemeral").prop("style", "display:none;");
            $("#node-row-commandResponseType").prop("style", "display:none;");
          }            
        }
        else if ($("#node-input-interactionType").val() == "autoComplete" || 
          $("#node-input-interactionType").val() == "modalSubmit"){
          $("#node-row-responseType").prop("style", "display:none;");
        }
        else{
          $("#node-input-custom_id-lbl").text("Custom Ids");          
          $("#node-row-ephemeral").prop("style", "display:none;");
          $("#node-row-responseType").prop("style", "");
        }        
      });
    },
    label: function () {
      return this.name || "Discord Interaction";
    }
  });

  
</script>
<script type="text/x-red" data-template-name="discordInteraction">
  <div class="form-row">
        <label for="node-input-token"><i class="icon-tag"></i> token</label>
        <input type="text" id="node-input-token" placeholder="token">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-interactionType"><i class="icon-tag"></i> Interaction type</label>
        <input type="text" id="node-input-interactionType">
    </div>
    <div class="form-row">
        <label for="node-input-custom_id" id="node-input-custom_id-lbl"><i class="icon-tag"></i> Custom Id</label>
        <input type="text" id="node-input-custom_id" placeholder="customid1,customid2,etc">
        <p>(leave blank to not filter by custom_id/commandName, or separated by ',' for more than one custom_id/commandName)</p>
    </div>    
    <div class="form-row" id="node-row-ephemeral" style="display:none;">
        <input type="checkbox" id="node-input-ephemeral" style="display: inline-block; width: auto; vertical-align: top;">  
        <label for="node-input-ephemeral" style="width: 70%;"> Ephemeral</label>  
    </div>
    <div class="form-row" id="node-row-responseType" style="display:none;">
      <label for="node-input-responseType"><i class="icon-tag"></i> Response type</label>
      <input type="text" id="node-input-responseType">
    </div>
    <div class="form-row" id="node-row-commandResponseType" style="display:none;">
      <label for="node-input-commandResponseType"><i class="icon-tag"></i> Response type</label>
      <input type="text" id="node-input-commandResponseType">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-interactionObject" style="display: inline-block; width: auto; vertical-align: top;">  
        <label for="node-input-interactionObject" style="width: 70%;"> Inject interaction object</label>    
    </div>     
</script>
<script type="text/x-red" data-help-name="discordInteraction">
  <p><strong>What it does</strong> — Captures every interactive action your bot receives: slash commands, context-menu clicks, button presses, select menus, autocomplete requests, and modal submissions.</p>
  <p><strong>When to use it</strong> — Any time you expect the user to click something or run a command. Pair it with <code>discordInteractionManager</code> to send the reply back.</p>

  <h3>Output structure</h3>
  <dl class="message-properties">
      <dt>payload <span class="property-type">object</span></dt>
      <dd>General interaction details such as id, type, guild, channel, and command data.</dd>
      <dt>payload.user <span class="property-type">object</span></dt>
      <dd>Information about the user who triggered the interaction.</dd>
      <dt>payload.member <span class="property-type">object</span></dt>
      <dd>Guild-specific user data (roles, nicknames). Present when the interaction happens inside a server.</dd>
      <dt>payload.message <span class="property-type">object</span></dt>
      <dd>The original message that held the button or select menu (only for those interaction types).</dd>
      <dt>payload.options <span class="property-type">array</span></dt>
      <dd>Slash-command or context-menu options the user chose.</dd>
      <dt>interactionObject <span class="property-type">object</span></dt>
      <dd>The raw Discord.js interaction (only sent if you tick “Inject interaction object”). Use it when you need low-level access.</dd>
  </dl>

  <h3>Tips</h3>
  <ul>
    <li>Filter by interaction type or custom ids in the editor so your flow only catches the buttons or commands you care about.</li>
    <li>If you defer a reply (the default), finish the response with <code>discordInteractionManager</code> within 15 minutes.</li>
    <li>Autocomplete requests arrive very quickly; keep the logic after this node fast to avoid timeouts.</li>
    <li>Use <code>msg.payload.locale</code> and <code>msg.payload.guild_locale</code> to tailor responses based on the user’s language.</li>
  </ul>
</script>
